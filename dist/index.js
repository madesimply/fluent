function A(n){return typeof n=="object"&&n!==null}function d(n){return typeof n=="object"&&n!==null&&"method"in n&&typeof n.method=="string"&&"args"in n&&Array.isArray(n.args)}function g(n){return typeof n=="object"&&n!==null&&"chain"in n&&Array.isArray(n.chain)}function h(n,r,t){if(g(n))return x({api:r,chain:n.chain,ctx:t});if(Array.isArray(n))return n.map(e=>h(e,r,t));if(d(n))return{...n,args:n.args.map(e=>h(e,r,t))};if(typeof n=="object"&&n!==null){let e={};for(let i in n)e[i]=h(n[i],r,t);return e}return n}function F(n){let r=n.args.map(t=>JSON.stringify(t)).join(", ");return`${n.method}(${r})`}function y(n,r,t,e,i){let s={chain:t,run:o=>I(n,o,t,i),goto:o=>{if(!g(o)||o.chain.length===0)throw new Error("Goto must receive a non-empty Fluent");return y(n,r,[...t,...o.chain],e,i)},toString:()=>t.map(F).join(".").replace(/\.$/,"")};return new Proxy(s,{get(o,a){if(a in o)return o[a];let f,u;if(A(r)&&a in r)f=r[a],u=`${e}${e?".":""}${a}`;else if(A(n)&&a in n)f=n[a],u=a;else return;if(typeof f=="function")return(...c)=>{let l=u,T={args:c},C=[...t,{method:l,args:T.args,data:{},return:{}}];return y(n,r,C,e,i)};if(A(f))return y(n,f,t,u,i)}})}function m(n,r={}){let t={};for(let e in n)typeof n[e]=="function"?t[e]=n[e].bind(r):typeof n[e]=="object"&&n[e]!==null?t[e]=m(n[e],r):t[e]=n[e];return t}function b(n,r,t){if(!t)return[];let e;return typeof t=="string"?e=new Function("api","fluent",`
      const root = fluent({ api });
      const { ${Object.keys(n).join(",")} } = root;
      const chain = ${t};
      return chain.chain;
    `)(n,x):e=t,e.map(i=>d(i)?{...i,args:i.args.map(s=>h(s,n,r))}:i)}var w=()=>typeof p=="function"?p:typeof globalThis<"u"&&typeof globalThis.setImmediate=="function"?globalThis.setImmediate:(n,...r)=>setTimeout(n,0,...r),p=w();function I(n,r,t,e){let i=r,s=0,o=!1;function a(){if(s>=t.length)return i;let u=t[s];if(d(u)){let c=u.method.split(".").reduce((T,C)=>T[C],n);if(typeof c!="function")throw new Error(`Method ${u.method} not found in API`);let l=c(i,...u.args);if(l instanceof Promise)return l.then(T=>P(n,T,t.slice(s+1),e));i=l===void 0?i:l}return s++,a()}let f=a();return o?new Promise(u=>p(()=>u(f))):f}async function P(n,r,t,e){let i=r,s=0;for(;s<t.length;){let o=t[s];if(d(o)){let a=o.method.split(".").reduce((u,c)=>u[c],n);if(typeof a!="function")throw new Error(`Method ${o.method} not found in API`);let f=await a(i,...o.args);i=f===void 0?i:f}s++}return i}function x(n){let{api:r,ctx:t,chain:e}=n,i=m(r,t),s=b(i,t||{},e),o=(t==null?void 0:t.fluent)||{blocking:!1};return y(i,i,s,"",o)}export{x as fluent};
//# sourceMappingURL=index.js.map