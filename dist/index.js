function T(n,i,t){let{method:e,args:r}=t;return e.split(".").reduce((f,l)=>f[l],n)(i,...r||[])}async function b(n,i,t,e){await t,i=t===void 0?i:t;for(let r of e){let o=T(n,i,r);o instanceof Promise&&await o,i=o===void 0?i:o}return i}function p(n,i,t){let e=n.slice(t+1),r=JSON.stringify(i),o=e.findIndex(s=>JSON.stringify(s)===r);return o>-1?o:n.slice(0,t+1).findIndex(({goto:s,...u})=>JSON.stringify(u)===r)}function a(n,i,t,e){let r=[...i],o=(l,s=0)=>{var h;let u=-1;for(let y=s;y<r.length;y++){let c=r[y];if(c.goto&&c.goto.args){let g=p(r,c.goto.args[0],y);g>-1&&(u=g)}let d=T(n,l,c);if(d instanceof Promise){let g=r.slice(r.indexOf(c)+1);return b(n,l,d,g)}l=d===void 0?l:d,u>-1}if(u>-1){if((h=e==null?void 0:e.fluent)!=null&&h.blocking)return o(l,u);setTimeout(()=>o(l,u),0)}return l},f={get(l,s){if(s==="run")return o;if(s==="toJSON")return()=>r;if(s==="goto")return d=>{let g={method:"goto",args:JSON.parse(JSON.stringify(d))};return r[r.length-1].goto=g,a(n,[...r],t,e)};if(s==="toString")return()=>j(r);if(typeof s!="string")return;let h=(s in n?n[s]:void 0)?[s]:[...t,s],y=h.join("."),c=h.reduce((d,g)=>d[g],n);if(typeof c=="object"&&c!==null)return a(n,r,h,e);if(typeof c=="function")return c.length<=1?a(n,[...r,{method:y}],t,e):(...g)=>a(n,[...r,{method:y,args:g}],t,e)}};return new Proxy(()=>{},f)}function A(n,i){let t={};for(let e in n)typeof n[e]=="function"?t[e]=n[e].bind(i):typeof n[e]=="object"&&n[e]!==null?t[e]=A(n[e],i):t[e]=n[e];return t}function R(n,i,t){return n.map(e=>(e.args&&(e.args=e.args.map(r=>m(r,i,t))),e))}function m(n,i,t){let e=Array.isArray(n),r=!e&&typeof n=="object"&&n!==null;if(e)return n.every(o=>"method"in o)?P({api:i,chain:n,ctx:t}):n.map(o=>m(o,i,t));if(r){for(let o in n)n[o]=m(n[o],i,t);return n}return n}function x(n,i){let t=[],e=[],r=[],o=!1,f="";function l(s,u){return s in u}for(let s=0;s<n.length;s++){let u=n[s];if(u==="."&&!o)f&&l(f,i)&&(t.push({method:e.join(".")+"."+f,args:r.length?C(r,i):[]}),f="",r=[]),e=[];else if(u==="(")o=!0,f&&r.push("");else if(u===")")o=!1;else if(u===","&&!o)f&&r.push("");else{if(u===" ")continue;o?r.length>0?r[r.length-1]+=u:r.push(u):f===""?f+=u:(e.length>0||f)&&e.push(u)}}return f&&l(f,i)&&t.push({method:e.join(".")+"."+f,args:r.length?C(r,i):[]}),t}function C(n,i){return n.map(t=>(t=t.replace(/^['"]|['"]$/g,""),/^\w+\(/.test(t)?x(t,i):t))}function j(n){return n.map(i=>{var e;let t=(e=i.args)!=null&&e.length?`(${i.args.join(", ")})`:"";return`${i.method}${t}`}).join(".")}function P({api:n,chain:i=[],ctx:t}){let e=A(n,t||{}),r=typeof i=="string"?x(i,e):i,o=r.length?r.slice(-1)[0].method.split(".").slice(0,-1):[],f=i?R(r,e,t):[];return a(e,f,o,t||{})}export{P as fluent,R as initChain};
//# sourceMappingURL=index.js.map