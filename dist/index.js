function C(n,r,o){let{method:e,args:t}=o;return e.split(".").reduce((g,s)=>g[s],n)(r,...t||[])}async function x(n,r,o,e){await o,r=o===void 0?r:o;for(let t of e){let i=C(n,r,t);i instanceof Promise&&await i,r=i===void 0?r:i}return r}function A(n,r,o){let e=n.slice(o+1),t=JSON.stringify(r),i=e.findIndex(u=>JSON.stringify(u)===t);return i>-1?i:n.slice(0,o+1).findIndex(({goto:u,...f})=>JSON.stringify(f)===t)}function m(n,r=[],o=[],e){let t=[...r],i=(s,u=0)=>{var y;let f=-1;for(let a=u;a<t.length;a++){let c=t[a];if(c.goto&&c.goto.args){let l=A(t,c.goto.args[0],a);l>-1&&(f=l)}let d=C(n,s,c);if(d instanceof Promise){let l=t.slice(t.indexOf(c)+1);return x(n,s,d,l)}s=d===void 0?s:d,f>-1}if(f>-1){if((y=e==null?void 0:e.fluent)!=null&&y.blocking)return i(s,f);setTimeout(()=>i(s,f),0)}return s},g={get(s,u){if(u==="run")return i;if(u==="toJSON")return()=>t;if(u==="goto")return d=>{let l={method:"goto",args:JSON.parse(JSON.stringify(d))};return t[t.length-1].goto=l,m(n,[...t],o,e)};if(u==="toString")return()=>j(t);if(typeof u!="string")return;let y=(u in n?n[u]:void 0)?[u]:[...o,u],a=y.join("."),c=y.reduce((d,l)=>d[l],n);if(typeof c=="object"&&c!==null)return m(n,t,y,e);if(typeof c=="function")return c.length<=1?m(n,[...t,{method:a}],o,e):(...l)=>m(n,[...t,{method:a,args:l}],o,e)}};return new Proxy(()=>{},g)}function T(n,r){let o={};for(let e in n)typeof n[e]=="function"?o[e]=n[e].bind(r):typeof n[e]=="object"&&n[e]!==null?o[e]=T(n[e],r):o[e]=n[e];return o}function b(n,r,o){return n.map(e=>(e.args&&(e.args=e.args.map(t=>h(t,r,o))),e))}function h(n,r,o){let e=Array.isArray(n),t=!e&&typeof n=="object"&&n!==null;if(e)return n.every(i=>"method"in i)?P({api:r,chain:n,ctx:o}):n.map(i=>h(i,r,o));if(t){for(let i in n)n[i]=h(n[i],r,o);return n}return n}function p(n,r){let o=/(\w+)(?:\(([^)]*)\))?/g,e=[],t=r,i=[];for(;;){let g=o.exec(n);if(!g)break;let[,s,u]=g;if(!t[s]&&r[s]&&(t=r,i=[]),typeof t[s]=="function"){let f=i.length?`${i.join(".")}.${s}`:s;e.push({method:f,args:u?u.split(",").map(y=>y.trim()):[]})}else typeof t[s]=="object"&&(t=t[s],i.push(s));n.slice(o.lastIndex).trim().startsWith(".")||(t=r,i=[])}return e}function j(n){return n.map(r=>{var e;let o=(e=r.args)!=null&&e.length?`(${r.args.join(", ")})`:"";return`${r.method}${o}`}).join(".")}function P({api:n,chain:r=[],ctx:o}){let e=T(n,o||{}),t=typeof r=="string"?p(r,e):r,i=t.length?t.slice(-1)[0].method.split(".").slice(0,-1):[],g=r?b(t,e,o):[];return m(e,g,i,o||{})}export{P as fluent,b as initChain};
//# sourceMappingURL=index.js.map