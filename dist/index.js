function C(n,t,o){let{method:e,args:r}=o;return e.split(".").reduce((l,u)=>l[u],n)(t,...r||[])}async function x(n,t,o,e){await o,t=o===void 0?t:o;for(let r of e){let i=C(n,t,r);i instanceof Promise&&await i,t=i===void 0?t:i}return t}function b(n,t,o){let e=n.slice(o+1),r=JSON.stringify(t),i=e.findIndex(s=>JSON.stringify(s)===r);return i>-1?i:n.slice(0,o+1).findIndex(({goto:s,...g})=>JSON.stringify(g)===r)}function m(n,t,o,e){let r=[...t],i=(u,s=0)=>{var a;let g=-1;for(let c=s;c<r.length;c++){let f=r[c];if(f.goto&&f.goto.args){let d=b(r,f.goto.args[0],c);d>-1&&(g=d)}let y=C(n,u,f);if(y instanceof Promise){let d=r.slice(r.indexOf(f)+1);return x(n,u,y,d)}u=y===void 0?u:y,g>-1}if(g>-1){if((a=e==null?void 0:e.fluent)!=null&&a.blocking)return i(u,g);setTimeout(()=>i(u,g),0)}return u},l={get(u,s){if(s==="run")return i;if(s==="toJSON")return()=>r;if(s==="goto")return y=>{let d={method:"goto",args:JSON.parse(JSON.stringify(y))};return r[r.length-1].goto=d,m(n,[...r],o,e)};if(s==="toString")return()=>j(r);if(typeof s!="string")return;let a=(s in n?n[s]:void 0)?[s]:[...o,s],c=a.join("."),f=a.reduce((y,d)=>y[d],n);if(typeof f=="object"&&f!==null)return m(n,r,a,e);if(typeof f=="function")return f.length<=1?m(n,[...r,{method:c}],o,e):(...d)=>m(n,[...r,{method:c,args:d}],o,e)}};return new Proxy(()=>{},l)}function T(n,t){let o={};for(let e in n)typeof n[e]=="function"?o[e]=n[e].bind(t):typeof n[e]=="object"&&n[e]!==null?o[e]=T(n[e],t):o[e]=n[e];return o}function p(n,t,o){return n.map(e=>(e.args&&(e.args=e.args.map(r=>h(r,t,o))),e))}function h(n,t,o){let e=Array.isArray(n),r=!e&&typeof n=="object"&&n!==null;if(e)return n.every(i=>"method"in i)?P({api:t,chain:n,ctx:o}):n.map(i=>h(i,t,o));if(r){for(let i in n)n[i]=h(n[i],t,o);return n}return n}function A(n,t){let o=/(\w+)(?:\(([^)]*)\))?/g,e=[],r=t,i=[],l=[];for(;;){let u=o.exec(n);if(!u)break;let[,s,g]=u;if(!r[s]&&t[s]&&(r=t,i=[]),typeof r[s]=="function"){let a=i.length?`${i.join(".")}.${s}`:s,c=g?g.split(",").map(f=>R(f.trim(),t)):[];l.length>0?l.push({method:a,args:c}):e.push({method:a,args:c}),c.some(f=>Array.isArray(f))?l=[]:l=c}else typeof r[s]=="object"&&(r=r[s],i.push(s));n.slice(o.lastIndex).trim().startsWith(".")||(r=t,i=[],l=[])}return e}function R(n,t){return/^['"].*['"]$/.test(n)?n:A(n,t)}function j(n){return n.map(t=>{var e;let o=(e=t.args)!=null&&e.length?`(${t.args.join(", ")})`:"";return`${t.method}${o}`}).join(".")}function P({api:n,chain:t=[],ctx:o}){let e=T(n,o||{}),r=typeof t=="string"?A(t,e):t,i=r.length?r.slice(-1)[0].method.split(".").slice(0,-1):[],l=t?p(r,e,o):[];return m(e,l,i,o||{})}export{P as fluent,p as initChain};
//# sourceMappingURL=index.js.map