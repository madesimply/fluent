function T(n,o,t){let{method:e,args:r}=t;return e.split(".").reduce((m,u)=>m[u],n)(o,...r||[])}async function A(n,o,t,e){o=await t;for(let r of e){let i=T(n,o,r);i instanceof Promise&&await i,o=i}return o}function h(n,o,t){let e=n.slice(t+1),r=JSON.stringify(o),i=e.findIndex(s=>JSON.stringify(s)===r);return i>-1?i:n.slice(0,t+1).findIndex(({goto:s,...l})=>JSON.stringify(l)===r)}function a(n,o=[],t=[],e){let r=[...o],i=(u,s=0)=>{let l=-1;for(let c=s;c<r.length;c++){let d=r[c];if(d.goto&&d.goto.args){let f=h(r,d.goto.args[0],c);f>-1&&(l=f)}let y=T(n,u,d);if(y instanceof Promise){let f=r.slice(r.indexOf(d)+1);return A(n,u,y,f)}u=y,l>-1}if(l>-1){if(e.blocking)return i(u,l);setTimeout(()=>i(u,l),0)}return u},m={get(u,s){if(s==="run")return i;if(s==="toJSON")return()=>r;if(s==="goto")return f=>{let g={method:"goto",args:JSON.parse(JSON.stringify(f))};return r[r.length-1].goto=g,a(n,[...r],t,e)};if(typeof s!="string")return;let c=(s in n?n[s]:void 0)?[s]:[...t,s],d=c.join("."),y=c.reduce((f,g)=>f[g],n);if(typeof y=="object"&&y!==null)return a(n,r,c,e);if(typeof y=="function")return y.length<=1?a(n,[...r,{method:d}],t,e):(...g)=>a(n,[...r,{method:d,args:g}],t,e)}};return new Proxy(()=>{},m)}function x(n,o){let t={};for(let e in n)typeof n[e]=="function"?t[e]=n[e].bind(o):typeof n[e]=="object"&&n[e]!==null?t[e]=x(n[e],o):t[e]=n[e];return t}function b(n,o,t){return n.map(e=>(e.args&&(e.args=e.args.map(r=>C(r,o,t))),e))}function C(n,o,t){let e=Array.isArray(n),r=!e&&typeof n=="object"&&n!==null;if(e)return n.every(i=>"method"in i)?R({api:o,chain:n,ctx:t}):n.map(i=>C(i,o,t));if(r){for(let i in n)n[i]=C(n[i],o,t);return n}return n}function R({api:n,chain:o=[],ctx:t}){let e=o.length?o.slice(-1)[0].method.split(".").slice(0,-1):[],r=x(n,t||{}),i=o?b(o,n,t):[];return a(r,i,e,t||{})}export{R as fluent,b as initChain};
//# sourceMappingURL=index.js.map