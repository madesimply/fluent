{"version":3,"sources":["../src/index.ts","../src/fluent.ts"],"sourcesContent":["export * from \"./fluent\";","type AddApiKeys<T, U> = {\n  [K in keyof U]: U[K] extends (...args: infer P) => any\n    ? P extends [infer Ctx, ...infer Rest]\n      ? (...args: Rest) => AddConfigPropAndReturn<U, U>\n      : AddConfigPropAndReturn<U, U>\n    : AddConfigPropAndReturn<U[K], U>;\n};\n\nexport type AddConfigPropAndReturn<T, U> = T extends (...args: any[]) => any\n  ? Parameters<T> extends [infer Ctx, ...infer Rest]\n    ? ((...args: Rest) => AddConfigPropAndReturn<U, U>) & AddApiKeys<T, U>\n    : AddConfigPropAndReturn<U, U> & AddApiKeys<T, U>\n  : {\n      [P in keyof T]: T[P] extends (...args: any[]) => any\n        ? Parameters<T[P]> extends [infer Ctx, ...infer Rest]\n          ? ((...args: Rest) => AddConfigPropAndReturn<U, U>) & AddApiKeys<T, U>\n          : AddConfigPropAndReturn<U, U> & AddApiKeys<T, U> & T[P]\n        : AddConfigPropAndReturn<T[P], U>;\n    } & AddApiKeys<T, U>;\n\nexport type FluentApi<V, U> = AddConfigPropAndReturn<V, U>;\n\nexport type CombinedFluentApi<T> = {\n  [K in keyof T]: FluentApi<T[K], T>;\n};\n\nexport type ApiCall = { method: string; args?: any[]; goto?: ApiCall };\n\nexport function fluent<T extends Record<string, any>>(api: T): CombinedFluentApi<T> {\n  let chain: any = null;\n\n  const createProxy = (parentCalls: ApiCall[] = [], path: string[] = []): any => {\n    const calls = [...parentCalls];\n\n    const runMethod = (ctx: any, call: ApiCall) => {\n      const { method: path, args } = call;\n      const method: any = path.split(\".\").reduce((acc, key) => acc[key], api);\n      return method(ctx, ...(args || []));\n    };\n\n    const runPromises = async (ctx: any, firstResult: Promise<any>, calls: ApiCall[]) => {\n      ctx = await firstResult;\n      for (const call of calls) {\n        const result = runMethod(ctx, call);\n        if (result instanceof Promise) {\n          await result;\n        }\n        ctx = result;\n      }\n      return ctx;\n    };\n\n    // search from current index to end of calls\n    // if not found, search from start to current index\n    const callIndex = (call, current) => {\n      const remaining = calls.slice(current + 1);\n      const gotoCall = JSON.stringify(call);\n      const nextIndex = remaining.findIndex(\n        (c) => JSON.stringify(c) === gotoCall\n      );\n      if (nextIndex > -1) {\n        return nextIndex;\n      }\n      const start = calls.slice(0, current + 1);\n      const prevIndex = start.findIndex(\n        ({ goto, ...c }) => JSON.stringify(c) === gotoCall\n      );\n      return prevIndex;\n    };\n\n    const run = (ctx, from = 0) => {\n      let goto = -1;\n      for (let i = from; i < calls.length; i++) {\n        let call = calls[i];\n        if (call.goto && call.goto.args) {\n          const index = callIndex(call.goto.args[0], i);\n          if (index > -1) goto = index;\n        }\n        const result = runMethod(ctx, call);\n        if (result instanceof Promise) {\n          const remaining = calls.slice(calls.indexOf(call) + 1);\n          return runPromises(ctx, result, remaining);\n        }\n        ctx = result;\n        if (goto > -1) \n          continue;\n      }\n      if (goto > -1) {\n        setTimeout(() => run(ctx, goto), 0);\n      }\n      return ctx;\n    };\n\n    const handler: ProxyHandler<any> = {\n      get(_, prop: string | symbol): any {\n        if (prop === \"run\") return run;\n        if (prop === \"toJSON\") return () => calls;\n        if (prop === \"goto\")\n          return (call: ApiCall) => {\n            const goto = {\n              method: \"goto\",\n              args: JSON.parse(JSON.stringify(call)),\n            };\n            calls[calls.length - 1].goto = goto;\n            return createProxy([...calls], path);\n          };\n\n        if (typeof prop !== \"string\") return undefined;\n\n        const baseTarget = prop in api ? api[prop] : undefined;\n        const newPath = baseTarget ? [prop] : [...path, prop];\n        const fullPath = newPath.join(\".\");\n        const target = baseTarget || newPath.reduce((acc, key) => acc[key], api);\n\n        if (typeof target === \"object\") {\n          return createProxy(calls, newPath);\n        }\n\n        if (typeof target === \"function\") {\n          const func = target as Function;\n          if (func.length <= 1) {\n            return createProxy([...calls, { method: fullPath }], path);\n          }\n          return (...args: any[]) => {\n            return createProxy([...calls, { method: fullPath, args }], path);\n          };\n        }\n\n        return undefined;\n      },\n    };\n\n    return new Proxy(() => {}, handler);\n  };\n\n  chain = createProxy() as CombinedFluentApi<T>;\n  return chain;\n}\n\nexport const toChain = (op: string, fluent: any): any => {\n  const config: ApiCall[] =\n    typeof op === \"string\" ? JSON.parse(op) : JSON.parse(JSON.stringify(op));\n\n  let current = fluent;\n  for (const { method, args } of config) {\n    const methods = method.split(\".\");\n    for (const m of methods) {\n      if (methods.indexOf(m) === methods.length - 1 && args?.length) {\n        const _args = args.map((arg) => { \n          const args = Array.isArray(arg) ? arg : [arg];\n          const hasChain = args.some((a) => a.method);\n          return hasChain ? toChain(arg, fluent) : arg;\n        });\n\n        current = current[m](..._args);\n        continue;\n      }\n      current = current[m];\n    }\n  }\n\n  return current;\n};\n"],"mappings":"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","names":["path","calls","fluent","args"]}