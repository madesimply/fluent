{"version":3,"sources":["../src/index.ts","../src/fluent.ts"],"sourcesContent":["export * from \"./fluent\";\nexport * from \"./types\";","import { ApiCall, Ctx, Fluent, RequiredContext } from \"./types\";\n\nfunction runMethod(api: Record<string, any>, ctx: any, call: ApiCall) {\n  const { method, args } = call;\n  const methodFunc: any = method.split(\".\").reduce((acc, key) => acc[key], api);\n  return methodFunc(ctx, ...(args || []));\n}\n\nasync function runPromises(api: Record<string, any>, ctx: any, firstResult: Promise<any>, calls: ApiCall[]) {\n  ctx = await firstResult;\n  for (const call of calls) {\n    const result = runMethod(api, ctx, call);\n    if (result instanceof Promise) {\n      await result;\n    }\n    ctx = result;\n  }\n  return ctx;\n}\n\nfunction callIndex(calls: ApiCall[], call: ApiCall, current: number) {\n  const remaining = calls.slice(current + 1);\n  const gotoCall = JSON.stringify(call);\n  const nextIndex = remaining.findIndex((c) => JSON.stringify(c) === gotoCall);\n  if (nextIndex > -1) {\n    return nextIndex;\n  }\n  const start = calls.slice(0, current + 1);\n  const prevIndex = start.findIndex(({ goto, ...c }) => JSON.stringify(c) === gotoCall);\n  return prevIndex;\n}\n\nfunction createProxy<T extends Record<string, any>>(api: T, parentCalls: ApiCall[] = [], path: string[] = [], config: Ctx): any {\n  const calls = [...parentCalls];\n\n  const run = (ctx: any, from = 0) => {\n    let goto = -1;\n    for (let i = from; i < calls.length; i++) {\n      let call = calls[i];\n      if (call.goto && call.goto.args) {\n        const index = callIndex(calls, call.goto.args[0], i);\n        if (index > -1) goto = index;\n      }\n      const result = runMethod(api, ctx, call);\n      if (result instanceof Promise) {\n        const remaining = calls.slice(calls.indexOf(call) + 1);\n        return runPromises(api, ctx, result, remaining);\n      }\n      ctx = result;\n      if (goto > -1) continue;\n    }\n    if (goto > -1) {\n      setTimeout(() => run(ctx, goto), 0);\n    }\n    return ctx;\n  };\n\n  const handler: ProxyHandler<any> = {\n    get(_, prop: string | symbol): any {\n      if (prop === \"run\") return run;\n      if (prop === \"toJSON\") return () => calls;\n      if (prop === \"goto\")\n        return (call: ApiCall) => {\n          const goto = {\n            method: \"goto\",\n            args: JSON.parse(JSON.stringify(call)),\n          };\n          calls[calls.length - 1].goto = goto;\n          return createProxy(api, [...calls], path, config);\n        };\n\n      if (typeof prop !== \"string\") return undefined;\n\n      const baseTarget = prop in api ? api[prop] : undefined;\n      const newPath = baseTarget ? [prop] : [...path, prop];\n      const fullPath = newPath.join(\".\");\n      const targetValue = newPath.reduce((acc, key) => acc[key], api);\n\n      if (typeof targetValue === \"object\" && targetValue !== null) {\n        return createProxy(api, calls, newPath, config);\n      }\n\n      if (typeof targetValue === \"function\") {\n        const func = targetValue as Function;\n        if (func.length <= 1) {\n          return createProxy(api, [...calls, { method: fullPath }], path, config);\n        }\n        return (...args: any[]) => {\n          return createProxy(api, [...calls, { method: fullPath, args }], path, config);\n        };\n      }\n\n      return undefined;\n    },\n  };\n\n  return new Proxy(() => {}, handler);\n}\n\nfunction bindConfigToApi<T extends Record<string, any>>(api: T, ctx: Ctx): T {\n  const boundApi = {} as T;\n\n  for (const key in api) {\n    if (typeof api[key] === 'function') {\n      // Bind the configuration to the function\n      boundApi[key] = api[key].bind(ctx);\n    } else if (typeof api[key] === 'object' && api[key] !== null) {\n      // Recursively bind the configuration for nested objects\n      boundApi[key] = bindConfigToApi(api[key], ctx);\n    } else {\n      boundApi[key] = api[key];\n    }\n  }\n\n  return boundApi;\n}\n\nexport function fluent<T extends Record<string, any>>({ api, chain = [], ctx } : { api: T, chain?: ApiCall[], ctx: RequiredContext<T>}): Fluent<T> {\n  const path = chain.length ? chain.slice(-1)[0].method.split('.').slice(0,-1) : [];\n  const boundApi = bindConfigToApi(api, ctx || {});\n  return createProxy(boundApi, chain, path, ctx || {}) as Fluent<T>;\n}"],"mappings":"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","names":[]}