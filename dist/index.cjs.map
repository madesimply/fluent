{"version":3,"sources":["../src/index.ts","../src/fluent.ts"],"sourcesContent":["export * from \"./fluent\";","// fluent.ts\nimport {\n  Chain,\n  Fluent,\n  FluentConfig,\n  FluentStructure,\n  ApiContext,\n  HasRequiredProperties,\n  FluentOptions,\n} from './types';\n\n// Utility functions\nfunction isObject(value: unknown): value is Record<string, unknown> {\n  return typeof value === 'object' && value !== null;\n}\n\nfunction isChainItem(item: unknown): item is Chain[number] {\n  return (\n    typeof item === 'object' &&\n    item !== null &&\n    'method' in item &&\n    typeof (item as any).method === 'string' &&\n    'args' in item &&\n    Array.isArray((item as any).args)\n  );\n}\n\nfunction isFluent(value: unknown): value is FluentStructure {\n  return (\n    typeof value === 'object' &&\n    value !== null &&\n    'chain' in value &&\n    Array.isArray((value as any).chain)\n  );\n}\n\nfunction processArgument(arg: unknown, api: any, ctx: any): any {\n  if (isFluent(arg)) {\n    return fluent({ api, chain: arg.chain, ctx });\n  }\n  if (Array.isArray(arg)) {\n    return arg.map((item) => processArgument(item, api, ctx));\n  }\n  if (isChainItem(arg)) {\n    return {\n      ...arg,\n      args: arg.args.map(a => processArgument(a, api, ctx))\n    };\n  }\n  if (typeof arg === 'object' && arg !== null) {\n    const processedArg: Record<string, any> = {};\n    for (const key in arg) {\n      processedArg[key] = processArgument((arg as any)[key], api, ctx);\n    }\n    return processedArg;\n  }\n  return arg;\n}\n\nfunction chainItemToString(item: Chain[number]): string {\n  const args = item.args.map(arg => JSON.stringify(arg)).join(', ');\n  return `${item.method}(${args})`;\n}\n\nfunction createProxy<TRootApi, TCurrentApi, TCurrentChain extends Chain, TPath extends string>(\n  rootApi: TRootApi,\n  currentApi: TCurrentApi,\n  currentChain: TCurrentChain,\n  path: TPath,\n  options: FluentOptions\n): Fluent<TRootApi, TCurrentApi, TCurrentChain, TPath> {\n  const target: Fluent<TRootApi, TCurrentApi, TCurrentChain, TPath> = {\n    chain: currentChain,\n    run: (data: any) => runChain(rootApi, data, currentChain, options),\n    goto: (fluentProxy: FluentStructure) => {\n      if (!isFluent(fluentProxy) || fluentProxy.chain.length === 0) {\n        throw new Error(\"Goto must receive a non-empty Fluent\");\n      }\n      return createProxy(rootApi, currentApi, [...currentChain, ...fluentProxy.chain] as any, path, options);\n    },\n    toString: () => currentChain.map(chainItemToString).join('.').replace(/\\.$/, '')\n  } as Fluent<TRootApi, TCurrentApi, TCurrentChain, TPath>;\n\n  return new Proxy(target, {\n    get(target, prop: string | symbol) {\n      if (prop in target) {\n        return (target as any)[prop];\n      }\n\n      let nextApi: unknown;\n      let nextPath: string;\n\n      if (isObject(currentApi) && prop in currentApi) {\n        nextApi = (currentApi as any)[prop];\n        nextPath = `${path}${path ? '.' : ''}${prop as string}`;\n      } else if (isObject(rootApi) && prop in rootApi) {\n        nextApi = (rootApi as any)[prop];\n        nextPath = prop as string;\n      } else {\n        return undefined;\n      }\n\n      if (typeof nextApi === 'function') {\n        return (...args: any[]) => {\n          const method = nextPath;\n          const newChain = [\n            ...currentChain,\n            { \n              method, \n              args: args.map(arg => isFluent(arg) ? arg.chain[0] : arg),\n              data: {} as any,\n              return: {} as any\n            }\n          ];\n          return createProxy(rootApi, currentApi, newChain, path, options);\n        };\n      }\n\n      if (isObject(nextApi)) {\n        return createProxy(rootApi, nextApi as any, currentChain, nextPath, options);\n      }\n\n      return undefined;\n    }\n  });\n}\nfunction bindApiToContext<TApi, TCtx>(api: TApi, ctx: TCtx = {} as TCtx): TApi {\n  const boundApi: any = {};\n  for (const key in api) {\n    if (typeof api[key] === 'function') {\n      boundApi[key] = (api[key] as Function).bind(ctx);\n    } else if (typeof api[key] === 'object' && api[key] !== null) {\n      boundApi[key] = bindApiToContext(api[key], ctx);\n    } else {\n      boundApi[key] = api[key];\n    }\n  }\n  return boundApi as TApi;\n}\n\nfunction parseInitialChain<TApi, TCtx, T extends Chain | string | undefined>(\n  api: TApi,\n  ctx: TCtx,\n  chain: T\n): T extends string ? Chain : T extends Chain ? T : [] {\n  if (!chain) return [] as any;\n\n  let jsonChain: Chain;\n  if (typeof chain === 'string') {\n    const getChain = new Function(\"api\", \"fluent\", `\n      const root = fluent({ api });\n      const { ${Object.keys(api as object).join(\",\")} } = root;\n      const chain = ${chain};\n      return chain.chain;\n    `);\n    jsonChain = getChain(api, fluent);\n  } else {\n    jsonChain = chain as Chain;\n  }\n\n  return jsonChain.map((item) => {\n    if (isChainItem(item)) {\n      return {\n        ...item,\n        args: item.args.map((arg) => processArgument(arg, api, ctx))\n      };\n    }\n    return item;\n  }) as any;\n}\n\n// Utility function to get a cross-environment compatible setImmediate\nconst getSetImmediate = () => {\n  if (typeof setImmediate === 'function') {\n    return setImmediate;\n  }\n  if (typeof globalThis !== 'undefined' && typeof globalThis.setImmediate === 'function') {\n    return globalThis.setImmediate;\n  }\n  return (fn: Function, ...args: any[]) => setTimeout(fn, 0, ...args);\n};\n\n// Use the utility function to create our setImmediate\nconst setImmediate = getSetImmediate();\n\nfunction runChain<TApi>(api: TApi, initialData: any, chain: Chain, options: FluentOptions): any {\n  let data = initialData;\n  let index = 0;\n  let isAsync = false;\n\n  function processNextItem(): any {\n    if (index >= chain.length) {\n      return data;\n    }\n\n    const item = chain[index];\n\n    if (isChainItem(item)) {\n      const method = item.method.split('.').reduce((obj: any, key) => obj[key], api);\n      if (typeof method !== 'function') {\n        throw new Error(`Method ${item.method} not found in API`);\n      }\n\n      const result = method(data, ...item.args);\n\n      if (result instanceof Promise) {\n        return result.then(resolvedData => \n          runAsyncChain(api, resolvedData, chain.slice(index + 1), options)\n        );\n      }\n\n      data = result === undefined ? data : result;\n    }\n\n    index++;\n    return processNextItem();\n  }\n\n  const result = processNextItem();\n  return isAsync ? new Promise(resolve => setImmediate(() => resolve(result))) : result;\n}\n\nasync function runAsyncChain<TApi>(api: TApi, initialData: any, chain: Chain, options: FluentOptions): Promise<any> {\n  let data = initialData;\n  let index = 0;\n\n  while (index < chain.length) {\n    const item = chain[index];\n\n    if (isChainItem(item)) {\n      const method = item.method.split('.').reduce((obj: any, key) => obj[key], api);\n      if (typeof method !== 'function') {\n        throw new Error(`Method ${item.method} not found in API`);\n      }\n\n      const result = await method(data, ...item.args);\n      data = result === undefined ? data : result;\n    }\n\n    index++;\n  }\n\n  return data;\n}\n\nexport function fluent<TApi, TCtx extends ApiContext<TApi>, TInitialChain extends Chain = []>(\n  config: HasRequiredProperties<ApiContext<TApi>> extends true\n    ? FluentConfig<TApi, ApiContext<TApi>, TInitialChain> & { ctx: ApiContext<TApi> }\n    : FluentConfig<TApi, ApiContext<TApi>, TInitialChain>\n): Fluent<TApi, TApi, TInitialChain, \"\"> {\n  const { api, ctx, chain: initialChain } = config;\n\n  const boundApi = bindApiToContext(api, ctx);\n  const parsedChain = parseInitialChain(boundApi, ctx || {}, initialChain) as TInitialChain;\n\n  const options = ctx?.fluent || { blocking: false };\n\n  return createProxy(boundApi, boundApi, parsedChain, \"\", options);\n}\n\n// export types\n\nexport {\n  Fluent,\n  FluentConfig,\n  ApiContext,\n  FluentOptions,\n};"],"mappings":"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","names":["target","result"]}